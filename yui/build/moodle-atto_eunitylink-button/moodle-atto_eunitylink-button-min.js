YUI.add("moodle-atto_eunitylink-button",function(e,t){var n="atto_eunitylink",r={LINKTEXT:"linktext",ACCESSIONNUMBER:"accessionnumber"},i='<form class="atto_form"><div class="m-b-1 form-group"><label for="{{CSS.LINKTEXT}}">{{get_string "linktext" component}}</label><input class="form-control fullwidth {{CSS.LINKTEXT}}" type="text" id="{{CSS.LINKTEXT}}" value="{{selectedtext}}"  size="32"/></div><div class="m-b-1 form-group"><label for="{{CSS.ACCESSIONNUMBER}}">{{get_string "accessionnumber" component}}</label><input class="form-control fullwidth {{CSS.ACCESSIONNUMBER}}" name="{{CSS.ACCESSIONNUMBER}}" id="{{CSS.ACCESSIONNUMBER}}" value="{{accessionnumber}}" type="text" size="32"/></div><div class="mdl-align"><br/><button type="submit" title = {{get_string "createlink" component}} class="btn btn-default submit">{{get_string "createlink" component}}</button></div></form>';e.namespace("M.atto_eunitylink").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_accessionNumber:null,_content:null,_selectedText:null,initializer:function(){if(this.get("disabled"))return;var icon='iconone';this.addButton({tags:"IL, strong",icon:'ed/'+icon,iconComponent:'atto_eunitylink',buttonName:icon,exec:"ilink",callback:this._displayDialogue})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1||this._currentSelection.collapsed)return;var t=this.get("host").getSelectionParentNode();if(this._currentSelection.toString()===""||!t)return;var r=this._findSelectedAnchors(e.one(t)),i=this._getLinkHash();if(r.length>0&&i){var s=this._getDbVals(i);this._accessionNumber=s.result.accessionnumber}else this._accessionNumber=null;var o=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"auto",selectedtext:this._currentSelection,accessionnumber:this._accessionnumber,focusAfterHide:!0});o.set("bodyContent",this._getDialogueContent()),o.show()},_getLinkHash:function(){var t=this.get("host").getSelectionParentNode(),n=this._findSelectedAnchors(e.one(t)),r=n[0];if(!t.wholeText||!r)return"";var i=r.getAttribute("href"),s=this._getUrlVars(i);return s.hash},_getDbVals:function(e){var t;return YUI().use("io-base",function(n){var r={action:"get_dbvals",hash:e,contextid:M.cfg.contextid},i={sync:!0,data:r,arguments:{context:this,timeout:500,method:"POST"}},s=M.cfg.wwwroot+"/local/linkproxy/rest.php",o=n.io(s,i);t=JSON.parse(o.responseText)}),t?t:{}},_getUrlVars:function(e){var t={};return e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,n,r){t[n]=r}),t},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_setLink:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide();var t=this._content.one(".linktext").get("value");t!==""&&this._setLinkOnSelection()},_setLinkOnSelection:function(){var t=this.get("host"),n,r;this.editor.focus(),t.setSelection(this._currentSelection);var i=this._content.one(".accessionnumber").get("value"),s=this._getLinkHash();YUI().use("io-base",function(e){var t={action:"upsert_link",an:i,hash:s,contextid:M.cfg.contextid},n={sync:!0,data:t,arguments:{context:this,timeout:500,method:"POST"}},r=M.cfg.wwwroot+"/local/linkproxy/rest.php",o=e.io(r,n);s=JSON.parse(o.responseText)});var o=M.cfg.wwwroot+"/local/linkproxy/rest.php?action=get_link&hash="+s.result,u=document.getSelection();if(this._currentSelection[0].collapsed)n=e.Node.create("<a>"+o+"</a>"),n.setAttribute("href",o),r=t.insertContentAtFocusPoint(n.get("outerHTML")),t.setSelection(t.getSelectionFromNode(r)),u.anchorNode.parentElement.target="_blank";else{var a=window.getSelection(),f=this._content.one(".linktext").get("value");if(a.rangeCount){var l=a.getRangeAt(0);l.deleteContents(),l.insertNode(document.createTextNode(f))}document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,o),u.anchorNode.parentElement.target="_blank",r=t.getSelectionParentNode()}return r.wholeText?r:!1},_getDialogueContent:function(){var t=e.Handlebars.compile(i);return this._currentSelection||(this._accessionNumber=null),this._content=e.Node.create(t({component:n,selectedtext:this._currentSelection,accessionnumber:this._accessionNumber,CSS:r})),this._content.one(".submit").on("click",this._setLink,this),this._content}},{ATTRS:{disabled:{value:!1},hosturl:{value:""},queryparams:{value:""}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
